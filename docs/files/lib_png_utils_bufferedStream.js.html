<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/png/utils/bufferedStream.js - pngjs-image</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="pngjs-image"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.11.5</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/bKGD.html">bKGD</a></li>
            
                <li><a href="../classes/BufferedStream.html">BufferedStream</a></li>
            
                <li><a href="../classes/cHRM.html">cHRM</a></li>
            
                <li><a href="../classes/Chunk.html">Chunk</a></li>
            
                <li><a href="../classes/chunkUtils.html">chunkUtils</a></li>
            
                <li><a href="../classes/Compressor.html">Compressor</a></li>
            
                <li><a href="../classes/constants.html">constants</a></li>
            
                <li><a href="../classes/CRC.html">CRC</a></li>
            
                <li><a href="../classes/Decoder.html">Decoder</a></li>
            
                <li><a href="../classes/Encoder.html">Encoder</a></li>
            
                <li><a href="../classes/Filter.html">Filter</a></li>
            
                <li><a href="../classes/gAMA.html">gAMA</a></li>
            
                <li><a href="../classes/hIST.html">hIST</a></li>
            
                <li><a href="../classes/iCCP.html">iCCP</a></li>
            
                <li><a href="../classes/IDAT.html">IDAT</a></li>
            
                <li><a href="../classes/IEND.html">IEND</a></li>
            
                <li><a href="../classes/IHDR.html">IHDR</a></li>
            
                <li><a href="../classes/Interlace.html">Interlace</a></li>
            
                <li><a href="../classes/iTXt.html">iTXt</a></li>
            
                <li><a href="../classes/jsOn.html">jsOn</a></li>
            
                <li><a href="../classes/Normalizer.html">Normalizer</a></li>
            
                <li><a href="../classes/pHYs.html">pHYs</a></li>
            
                <li><a href="../classes/PLTE.html">PLTE</a></li>
            
                <li><a href="../classes/PNGImage.html">PNGImage</a></li>
            
                <li><a href="../classes/sBIT.html">sBIT</a></li>
            
                <li><a href="../classes/Scaler.html">Scaler</a></li>
            
                <li><a href="../classes/Scanline Parser.html">Scanline Parser</a></li>
            
                <li><a href="../classes/sPLT.html">sPLT</a></li>
            
                <li><a href="../classes/sRGB.html">sRGB</a></li>
            
                <li><a href="../classes/stRT.html">stRT</a></li>
            
                <li><a href="../classes/tEXt.html">tEXt</a></li>
            
                <li><a href="../classes/tIME.html">tIME</a></li>
            
                <li><a href="../classes/tRNS.html">tRNS</a></li>
            
                <li><a href="../classes/utils.html">utils</a></li>
            
                <li><a href="../classes/zTXt.html">zTXt</a></li>
            
                <li><a href="../classes/zzZz.html">zzZz</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Core.html">Core</a></li>
            
                <li><a href="../modules/PNG.html">PNG</a></li>
            
                <li><a href="../modules/PNGChunks.html">PNGChunks</a></li>
            
                <li><a href="../modules/PNGChunks

Options:
- background {boolean} - Should this chunk be applied to the image? (default: false).html">PNGChunks

Options:
- background {boolean} - Should this chunk be applied to the image? (default: false)</a></li>
            
                <li><a href="../modules/PNGChunks

Options:
- gamma {boolean} - Should this chunk be applied to the image? (default: false).html">PNGChunks

Options:
- gamma {boolean} - Should this chunk be applied to the image? (default: false)</a></li>
            
                <li><a href="../modules/PNGChunks

Options:
- transparent {boolean} - Should this chunk be applied to the image? (default: true).html">PNGChunks

Options:
- transparent {boolean} - Should this chunk be applied to the image? (default: true)</a></li>
            
                <li><a href="../modules/PNGCore.html">PNGCore</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/png/utils/bufferedStream.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
// Copyright 2015 Yahoo! Inc.
// Copyrights licensed under the Mit License. See the accompanying LICENSE file for terms.

/**
 * @class BufferedStream
 * @module PNG
 * @submodule PNGCore
 * @param {Buffer} [data] Data buffer
 * @param {int|boolean} [offset=0] Offset within the data (With offset = false, they data will be taken as-is)
 * @param {int} [length=data.length-offset] Length of the data
 * @constructor
 */
var BufferedStream = function (data, offset, length) {

	this.readOffset = 0;
	this.writeOffset = 0;

	this.readCounter = 0;
	this.writeCounter = 0;

	if (data) {
		if (offset === false) {
			this._data = data;
			this.writeOffset = data.length;
		} else {
			this._data = new Buffer((length || (data.length - (offset || 0))) * 2);
			this.writeBuffer(data, offset, length);
		}
	} else {
		if (length === 0) {
			this._data = new Buffer();
		} else {
			this._data = new Buffer(length || 1024 * 500);
		}
	}
};

Object.defineProperty(BufferedStream.prototype, &#x27;length&#x27;, {
	enumerable: false,
	configurable: false,
	get: function () {
		return this.writeOffset - this.readOffset;
	},
	set: function (length) {
		if (this.readOffset + length &gt; this.writeOffset) {
			throw new Error(&#x27;Length beyond the write pointer is not allowed.&#x27;);
		}
		this.writeOffset = this.readOffset + length;
	}
});

/**
 * Returns the number of bytes left before resizing
 *
 * @method getSpaceLeft
 * @return {int}
 */
BufferedStream.prototype.getSpaceLeft = function () {
	return this._data.length - this.writeOffset;
};


/**
 * Checks if a read goes beyond the write pointer, reaching out of bounds
 *
 * @method _readCheck
 * @param {int} size Size of the data that is pending to be read from the stream
 * @private
 */
BufferedStream.prototype._readCheck = function (size) {
	if (this.readOffset + size &gt; this.writeOffset) {
		throw new Error(&#x27;Reading out of bounds.&#x27;);
	}
};

/**
 * Skips a number of bytes
 *
 * @param {int} count Number of bytes to skip
 */
BufferedStream.prototype.skip = function (count) {
	this.readOffset += count;
	this.readCounter += count;
};

/**
 * @method readUInt8
 * @param {boolean} [noAssert=false]
 * @return {int}
 */
/**
 * @method peekUInt8
 * @param {boolean} [noAssert=false]
 * @return {int}
 */
[
	[&#x27;UInt16LE&#x27;, 2],
	[&#x27;UInt16BE&#x27;, 2],
	[&#x27;UInt32LE&#x27;, 4],
	[&#x27;UInt32BE&#x27;, 4],
	[&#x27;Int8&#x27;, 1],
	[&#x27;Int16LE&#x27;, 2],
	[&#x27;Int16BE&#x27;, 2],
	[&#x27;Int32LE&#x27;, 4],
	[&#x27;Int32BE&#x27;, 4],
	[&#x27;FloatLE&#x27;, 4],
	[&#x27;FloatBE&#x27;, 4],
	[&#x27;DoubleLE&#x27;, 8],
	[&#x27;DoubleBE&#x27;, 8]
].forEach(function (fnInfo) {

		[&#x27;read&#x27;, &#x27;peek&#x27;].forEach(function (prefix) {
			var relayedMethodName = &#x27;read&#x27; + fnInfo[0],
				methodName = prefix + fnInfo[0],
				peeking = (prefix === &#x27;peek&#x27;),
				size = fnInfo[1];

			BufferedStream.prototype[methodName] = function (noAssert) {
				var value;

				this._readCheck(size);

				value = this._data[relayedMethodName](this.readOffset, noAssert);
				if (!peeking) {
					this.readOffset += size;
					this.readCounter += size;
				}

				return value;
			}
		});
	});


BufferedStream.prototype.peekUInt8 = function () {
	return this._data[this.readOffset];
};

BufferedStream.prototype.readUInt8 = function () {
	var result = this._data[this.readOffset];
	this.readOffset++;
	this.readCounter++;
	return result;
};

BufferedStream.prototype.writeUInt8 = function (value) {
	this._writeCheck(1);
	this._data[this.writeOffset] = value &amp; 0xff;
	this.writeOffset++;
	this.writeCounter++;
};


//BufferedStream.prototype.peekUInt16BE = function () {
//	return (this._data[this.readOffset] &lt;&lt; 8) | this._data[this.readOffset + 1]
//};
//
//BufferedStream.prototype.readUInt16BE = function () {
//	var result = this.peekUInt16BE();
//	this.readOffset += 2;
//	this.readCounter += 2;
//	return result;
//};

BufferedStream.prototype.writeUInt16BE = function (value) {
	this._writeCheck(2);
	this._data[this.writeOffset] = (value &gt;&gt;&gt; 8) &amp; 0xff;
	this._data[this.writeOffset + 1] = value &amp; 0xff;
	this.writeOffset += 2;
	this.writeCounter += 2;
};


//BufferedStream.prototype.peekUInt32BE = function () {
//	return (this._data[this.readOffset] * 0x1000000) +
//		((this._data[this.readOffset + 1] &lt;&lt; 16) |
//		(this._data[this.readOffset + 2] &lt;&lt; 8) |
//		this._data[this.readOffset + 3]);
//};
//
//BufferedStream.prototype.readUInt32BE = function () {
//	var result = this.peekUInt32BE();
//	this.readOffset += 4;
//	this.readCounter += 4;
//	return result;
//};

BufferedStream.prototype.writeUInt32BE = function (value) {
	this._writeCheck(4);
	this._data[this.writeOffset] = (value &gt;&gt;&gt; 24) &amp; 0xff;
	this._data[this.writeOffset + 1] = (value &gt;&gt;&gt; 16) &amp; 0xff;
	this._data[this.writeOffset + 2] = (value &gt;&gt;&gt; 8) &amp; 0xff;
	this._data[this.writeOffset + 3] = value &amp; 0xff;
	this.writeOffset += 4;
	this.writeCounter += 4;
};


/**
 * Reads a string from the stream without moving the read pointer
 *
 * @method peekString
 * @param {int} size Number of bytes to read from stream
 * @param {string} [encoding=&#x27;utf8&#x27;] Encoding of string
 * @return {string}
 */
BufferedStream.prototype.peekString = function (size, encoding) {
	this._readCheck(size);
	return this._data.toString(encoding || &#x27;utf8&#x27;, this.readOffset, this.readOffset + size);
};

/**
 * Reads a string from the stream
 *
 * @method readString
 * @param {int} size Number of bytes to read from stream
 * @param {string} [encoding=&#x27;utf8&#x27;] Encoding of string
 * @return {string}
 */
BufferedStream.prototype.readString = function (size, encoding) {
	var result = this.peekString(size, encoding);
	this.readOffset += size;
	this.readCounter += size;
	return result;
};


/**
 * Reads data from the stream into a buffer without moving the read pointer
 *
 * @method peekBuffer
 * @param {int} size Number of bytes that should be read from the stream
 * @returns {Buffer}
 */
BufferedStream.prototype.peekBuffer = function (size) {
	var buffer;

	this._readCheck(size);

	buffer = new Buffer(size);
	this._data.copy(buffer, 0, this.readOffset, this.readOffset + size);

	return buffer;
};

/**
 * Reads data from the stream into a buffer
 *
 * @method readBuffer
 * @param {int} size Number of bytes that should be read from the stream
 * @return {Buffer}
 */
BufferedStream.prototype.readBuffer = function (size) {
	var buffer = this.peekBuffer(size);
	this.readOffset += size;
	this.readCounter += size;
	return buffer;
};


/**
 * Reads data from the stream into a buffer
 *
 * @method peekBufferedStream
 * @param {BufferedStream} stream Stream to write to
 * @param {int} size Number of bytes that should be read
 */
BufferedStream.prototype.peekBufferedStream = function (stream, size) {
	stream.writeBufferedStream(this, size);
};

/**
 * Reads data from the stream into a buffer
 *
 * @method readBufferedStream
 * @param {BufferedStream} stream Stream to write to
 * @param {int} size Number of bytes that should be read
 */
BufferedStream.prototype.readBufferedStream = function (stream, size) {
	this.peekBufferedStream(stream, size);
	this.readOffset += size;
	this.readCounter += size;
};


/**
 * Checks if a write needs a re-size
 *
 * @method _writeCheck
 * @param {int} size Size that is pending to be written to the stream
 * @private
 */
BufferedStream.prototype._writeCheck = function (size) {
	if (this._data.length &lt; this.writeOffset + size) {
		this._resize();
	}
};

/**
 * Re-sizes the internal buffer, copying all existing data into it
 *
 * @method _resize
 * @private
 */
BufferedStream.prototype._resize = function () {
	var buffer = new Buffer(this._data.length * 2);
	this._data.copy(buffer, 0, 0, this.writeOffset);
	this._data = buffer;
};

/**
 * @method writeUInt8
 * @param {boolean} [noAssert=false]
 */
[
	[&#x27;writeUInt16LE&#x27;, 2],
	[&#x27;writeUInt32LE&#x27;, 4],
	[&#x27;writeInt8&#x27;, 1],
	[&#x27;writeInt16LE&#x27;, 2],
	[&#x27;writeInt16BE&#x27;, 2],
	[&#x27;writeInt32LE&#x27;, 4],
	[&#x27;writeInt32BE&#x27;, 4],
	[&#x27;writeFloatLE&#x27;, 4],
	[&#x27;writeFloatBE&#x27;, 4],
	[&#x27;writeDoubleLE&#x27;, 8],
	[&#x27;writeDoubleBE&#x27;, 8]
].forEach(function (fnInfo) {
		BufferedStream.prototype[fnInfo[0]] = function (value, noAssert) {
			this._writeCheck(fnInfo[1]);
			this._data[fnInfo[0]](value, this.writeOffset, noAssert);
			this.writeOffset += fnInfo[1];
			this.writeCounter += fnInfo[1];
		}
	});

/**
 * Writes a string to the stream
 *
 * @method writeASCIIString
 * @param {string} text Text to write to the stream
 */
BufferedStream.prototype.writeASCIIString = function (text) {

	this._writeCheck(text.length);

	for(var i = 0, len = text.length; i &lt; len; i++) {
		this._data.writeUInt8(text.charCodeAt(i) &amp; 0xff, this.writeOffset + i);
	}
	this.writeOffset += text.length;
	this.writeCounter += text.length;
};

/**
 * Writes a string to the stream
 *
 * @method writeString
 * @param {string} text Text to write to the stream
 * @param {string} [encoding=&#x27;utf8&#x27;] Encoding of string
 */
BufferedStream.prototype.writeString = function (text, encoding) {
	this.writeBuffer(new Buffer(text, encoding || &#x27;utf8&#x27;));
};

/**
 * Writes a buffer to the stream
 *
 * @method writeBuffer
 * @param {Buffer} buffer Data buffer
 * @param {int} [offset=0] Offset within buffer
 * @param {int} [length=buffer.length-offset] length Length of buffer
 */
BufferedStream.prototype.writeBuffer = function (buffer, offset, length) {
	var localOffset = offset || 0,
		  localLength = length || (buffer.length - localOffset);

	this._writeCheck(localLength);

	buffer.copy(this._data, this.writeOffset, localOffset, localOffset + localLength);
	this.writeOffset += localLength;
	this.writeCounter += localLength;
};

/**
 * Writes a buffered stream into the stream
 *
 * @param {BufferedStream} stream
 * @param {int} [length=stream.length] Length of buffered data
 */
BufferedStream.prototype.writeBufferedStream = function (stream, length) {
	var len = (length || stream.length);

	this._writeCheck(len);

	stream._data.copy(this._data, this.writeOffset, stream.readOffset, stream.readOffset + len);
	this.writeOffset += len;
	this.writeCounter += len;
};


/**
 * Clones the stream with the current internal state
 *
 * @method clone
 * @return {BufferedStream} Cloned stream
 */
BufferedStream.prototype.clone = function () {
	return this.slice();
};

/**
 * Slices the stream
 *
 * @method slice
 * @param {int} [start=0] Start of stream
 * @param {int} [end=this.length] End of stream
 * @return {BufferedStream} Sliced stream
 */
BufferedStream.prototype.slice = function (start, end) {

	var stream,
		localStart = start || 0,
		localEnd = end || this._data.length;

	if (localStart &gt; localEnd) {
		throw new Error(&#x27;End cannot be smaller than start.&#x27;);
	}

	stream = new BufferedStream(this._data, false);

	stream.writeOffset = this.readOffset + localEnd;
	stream.readOffset = this.readOffset + localStart;

	stream.readCounter = this.readCounter;
	stream.writeCounter = this.writeCounter;

	return stream;
};

/**
 * Converts contents to a buffer without moving the read pointer
 *
 * @method toBuffer
 * @param {boolean} [noCopy=false]
 * @return {Buffer}
 */
BufferedStream.prototype.toBuffer = function (noCopy) {
	if (noCopy) {
		return this._data;
	} else {
		return this.peekBuffer(this.length);
	}
};


module.exports = BufferedStream;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
